# Move service discovery out of the playlist

## Initial state

The playlist is responsible for service discovery at different levels:
 1. it manages adding/removing SD
 2. it stores the input items generated by the SD into its tree
 3. it is used by UI models to display SD content


## Incremental steps


### Media browser

The first step (implemented by the first commit) moved the SD management into a
separate component
([`media_browser_t`][vlc_media_browser.h]/[`.c`][media_browser.c]). Initially,
this component still stored a pointer to the playlist, so that it could populate
the playlist directly on new SD events.

[vlc_media_browser.h]: include/vlc_media_browser.h
[media_browser.c]: src/media_browser/media_browser.c


### Media tree

The second step (implemented by the second commit) created a new structure
([`media_tree`][vlc_media_tree.h]/[`.c`][media_tree.c]) to
store a tree of media outside the playlist. Now, the _media browser_ manages and
populates _media trees_ instead of the playlist.

At the end, the UI should be client of the _media tree_ API, to display items
stored in a _media tree_.

However, as an intermediate step, I made the playlist a client of _media trees_.
Concretely, the playlist reflects changes notified by the media tree into its
own tree structure, so that we can keep the UI working while SD are managed by
the _media browser_ and populates _media trees_.

[vlc_media_tree.h]: include/vlc_media_tree.h
[media_tree.c]: src/media_tree/media_tree.c


### UI

The UI models (for example [`PLModel`][playlist_model.hpp] for Qt) need to be
adapted to use _media trees_ instead of the playlist.

[playlist_model.hpp]: modules/gui/qt/components/playlist/playlist_model.hpp



### Manage SD from a media browser

The first commit adds a new component
([`media_browser_t`][vlc_media_browser.h]). Its API is very similar to the
playlist API it replaces.



## Design discussions

### Media browser

TODO
 - lock in API? (or implicit `Hold` while internally locked to avoid race
   conditions)
 - identify SD by `char *`?
 - descriptor circular dependency
 - callbacks triggered even before `media_tree_Create returned?` (add a
   `pf_node_init` callback?)

### Media tree

TODO
 - many clients? (or 1 by intf) (impacts how we manage callbacks and `userdata`)
 - API by input?
 - same input for two nodes?
 - index input by id (for `FindByInput`)?

